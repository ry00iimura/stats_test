# 【統計学】一元配置分散分析

# 分散分析とは？
- 平均の差の検定を3群以上に拡張したもの
- Analysis of Variance ,ANOVAと呼ばれる
- 研究目的である、要因効果（要因効果のばらつき）が、誤差効果（残差効果のばらつき）よりも大きいとき、その分散比であるF値が大きくなることを利用する

# 何を検定しているのか？対立仮説と帰無仮説
- 対立仮説：A群、B群、C群の各平均に異なる値がある
 - A群の母集団の平均 ≠ B群の母集団の平均 = C 群の母集団の平均 は有意になる。
 - A群の母集団の平均 = B群の母集団の平均 ≠ C 群の母集団の平均 は有意になる。
 - A群の母集団の平均 ≠ B群の母集団の平均 ≠ C 群の母集団の平均 は有意になる。
 - A群の母集団の平均 = B群の母集団の平均 = C 群の母集団の平均 は有意にならない。
 - つまり、検定結果が棄却されても3群に差があることはわかるが、どこに差があるのかはわからないということ。

# 一元配置分散分析とは(one way -ANOVA)？
- 群(Control group)を分ける要因が一つしかない分散分析のこと
- A群:Docmoのスマホ, B群: Softbank C群：スマホなし　となったとき、これらを分けるのはスマホという要因一つのみ。
- こういった場合、例えば、A群の年収平均、B群の年収平均、C群の年収平均に差があるのかを検定するのが一元配置分散分析

# 2つのポイント
## 群のなかには「XXなし」とか「ニセモノ」を混ぜると「有意差」の後の打ち手が考えやすい
- 例えば、上の例でC群がAUで、有意差ありだった時、スマホの有無による年収平均の差が推し量れない
- 医療では、新薬の効果を検定するのに、「偽薬」も群の一つに混ぜて「気のせい」を防いでいる。

## 試行は反復させる
- 複数回独立した検定を行うわないと正しい結果は得られない。
- 何回検定すればいいかは、別の時に解説

# F値とは？
- 2つのχ二乗の比
- 分散が等しいかどうかを調べる検定がF検定
- F検定は、データが正規分布であることを前提としている。
- F検定の帰無仮説：2群間の分散に差がない。　対立仮説：2群間の分散に差がある。
- http://www.math.s.chiba-u.ac.jp/~yasuda/Chiba/%92P%8F%83%83N%83%8D%83X%8FW%8Cv/kiso7.htm

# χ二乗値とは？
-  https://staff.aist.go.jp/t.ihara/chi2.html
- 期待値との食い違いの尺度 = χ二乗値
- 食い違いがない状態 = χ二乗値が0の時。
- 例えば、赤玉と白玉が同数入っている箱から玉を20個取り出すとき、赤と白の期待値は赤10個、白10個（同じ数が箱に入っているから）。
- だけど、実際に20個玉を取り出すと、10個、10個じゃない取り合わせが出てくる。例えば赤9個、白11個みたいな。
- これを期待値との食い違いと言っている。
- ちなみに、χ二乗分布のもつある特徴で最も驚くべき発見は、元の玉の数の割合は、5:5だろうが4:6だろうが、自由度さえ同じであれば、分布の形が同じであるという点。
- 自由度とは、玉の種類の数-1。これは例えば赤玉の割合が2と決まれば、白玉の割合は8だと自動的に決まるので、2つのパラメータがあるように見えるが実際には1つが決まれば、もう一つは決まるということを利用して、自由に決められるパラメータの数＝自由度と読んでいる。
- χ二乗分布は、X軸にχ二乗値、Y軸に確率を取る。この確率はガンマ関数で導き出すことができる。

# F値検定
- 分散分析では、全体のばらつき = 要因効果によるばらつき + その他の効果によるばらつきと考える。
- 全体のばらつき(行列) = すべてのセルの値の平均 - セルの値
- 要因効果によるばらつき = 全体のばらつきの各要因群の平均
- その他の効果によるばらつき = 全体のばらつき - 要因効果によるばらつき(要因の影響は本来、各サンプルが等しく受ける。だけど値が違うのは、それ以外の要因があるからという考え方)
- F値の2つの分散とは、この「要因効果によるばらつき」と「その他の効果によるばらつき」のこと
- この時、この2つのばらつきの比＝つまるF値を計算する。仮にF値が同一母集団の分散比としてはめったに起きないずれであれば、それは、要因の効果が有意であるからという結論を導く。
- 例えば、お米が肥料A、肥料Bと肥料なしとで何センチ1か月あたりに伸びるかを観測し、そこに差があるかを検定する。この時、肥料が要因効果になる。しかし当然お米が生育するのは肥料による効果だけではない。その他の効果（例えば、土壌に住む生物や天候など）もある。F値は、分子が要因効果のばらつきで、分子が残差の効果のばらつきである。効果のばらつきが大きいということは、本来お米の成長はこれぐらいだろうと、予測していたのにその予想を大きく超えて発育した（あるいは発育しなかった）場合を表現している。つまり、効果が大きいとばらつきも大きくなる。故に、F値で要因効果と残差効果を比較したとき、相対的に要因効果のほうが大きければF値は大きい値になる。逆に残差効果のほうが大きればF値は小さい値になる（分母が大きくなるので）。F検定は、この要因効果が大きいかどうかを検定している。
- その他の効果によるばらつき = 残差のばらつき(言葉の置き換え)
- F値 = 分子（要因効果によるばらつき）　/ 分母（残差のばらつき）
- 残差のばらつきの自由度 = 全体のばらつきのセルの数（群数*試行回数) - 要因効果によるばらつきの自由度

# 等分散性
- 分散分析も各郡同士が同じ母集団から抽出されたサンプルであることを仮定として置いている。同じ母集団からきていればサンプル間の分散は等しいはずである。
- したがって、分散分析を行う前にこの前提をきちんとクリアしているかは確認したほうが良い。その際に用いられるのがBartlett検定である。
- Bartlett検定は、帰無仮説が「各郡の母分散に差がない」ことなので、帰無仮説を棄却しない（P値が0.05よりも大きい）ことを期待して検定する。
- 棄却できなければ、等分散ということができる。

# pythonコード
https://github.com/iimuragumi/hello-world/blob/master/ANOVA.ipynb

# 補助ノート
https://www.evernote.com/client/web?login=true#?an=true&n=164f4454-f350-438d-a634-7cdb29c97806&

# 紛らわしい用語
- 全体のばらつき = 総変動
- 要因効果によるばらつき = 群間変動
- その他効果によるばらつき = 郡内変動 = 誤差変動 = 残差変動

# 対応関係
## 対応のある、対応の内の主語は？
 - 各郡同士が
